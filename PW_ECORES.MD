# Весовая "Экоресурс" (PW_108d)
## Общее описание
 Устройство имеет память сообщений FIFO, как труба, в которую вкладывают шарики и извлекают со второго конца: ранее поступившее всегда будет извлечено раньше тех, которые поступили позже. Пример: мы закинули мячики в трубу со следующими словами:
 - красный
 - яблоко
 - полёт
 
Извлечены они будут в такой же последовательности: *красный*, *яблоко*, *полёт*. Шарики соответствуют поступившим событиям или сообщениям от других подключенных плат в той временной последовательности, в которой они происходили.

## Существующие команды и уведомления о событиях  
#### Команды 

Все команды начинаются с восклицательного знака "**!**". Строки ответа завершаются символами возврата каретки и перевода строки и в общем случае имеют вид **"сообщение\r\n"**.
 
**!D** - (delete) удаление сообщения и печать количества оставшихся. Строка ответа имеет вид "N",  где N - число оставшихся сообщений.
 
**!G** - (get) печать первого сообщения (все прочие до его удаления недоступны).
 
**!P** - (purge) удаляет первое сообщение и печатает количество оставшихся с памяти - *всегда 0*.
 
**!R29** - (relay) установка **высокого** уровня на выводе платы. После !R указывается номер вывода, на котром устанавливается высокий уровень. В приведённом примере задаётся уровень вывода №29. Для выводов с номерами от 100 и выше выполняется переадресация на 74hc595: 100..107 = 1-0..1-7, 108..115 = 2-0..2-7, и так далее.
 
**!r29** - установка **низкого** уровня на выводе платы. Аналогично предыдущей команде.
 
**!B15** - (button) установка **высокого** уровня на выводе платы и *после задержки* **низкого**. В данном примере вывода №15.
 
**!b15** - установка **низкого** уровня на выводе платы и *после задержки* **низкого**.  
  *ПРИМЕЧАНИЕ:* команды !B и !b на время задержки останавливают обработку событий и команд.
 
**!WX** | **!WY** - (weight) запрос веса у весов: !WX - у весов с литерой "X" и !WY - соответственно "Y".

С прошивки PW_108d доступны следующие команды:

**!L** - (list) выдача и **удаление** всех сообщений из накопителя.

**!V** - (version) добавление информации о имени файла прошивки (версии) в накопитель; на **Pro** такое же действие оказывает чтение карты с номером 11848164. Информация имеет следующий вид: 

+ **3fw:PW_108d.ino** 
    + **3** - номер платы, поместившей информацию.
    + **fw:** - firmware, "прошивка"
    + **PW_108d.ino** - имя файла при компиляции, соответвует версии.

**!T** | **!t** - (test) *включение|гашение* всех светодиодов, поключеных к *74hc595*

**!SO** | **!SN** - (Set ...) *(SX, SY, SL, SR)* команды-макросы, выполняют последовательность действий согласно техническому заданию для предустановки значений.

### События

Ответы на команды и события вырабатывают ответ, в общем случае содержащие номер подключенной платы, вид события и детализированную информацию о нём. 

**2reset** - произошёл аппаратный сброс платы с номером **2**. При штатной работе не должно встречаться, наиболее вероятная причина - аппаратный или программный сбой.

**4pr0:3456789** - считывание прокси-карты:
+ **4** - номер устройства, отправившего сообщение. Позволяет определить источник.
+ **pr:** - (proxy reader) - считывание карты или брелка на считывателе.
+ **03456789** - номер считанной карты.
  
**0iD5c** - изменение состояния контакта:
+ **0** - номер платы-отправителя.
+ **iD** - (input digital) изменение состояния входного контакта платы.
+ **5** - номер контакта, изменившего своё состояние.
+ **с** - уровень на контакте после события; может иметь значения: **c** - (closed) низкий уровень, или замкнут на землю и  **o** (open) - высокий уровень.

**0zx10011** - устаревшее, из прошивок версий PW_101 и раньше(не используется)
**0** - номер платы-отправителя; **zx** -  (Z exchange) - изменение уровня входного контакта; **10011** - состояния всех входных контактов после события, где каждое поле соответствует одному контакту и может принимать значения **0** или **1**.

**0wxC:ST, SG 18680kg** - ответ весов с результатами взвешивания  
Между типом запроса и **:** находится дополнительная информация о запросе  
1. **0** - номер уплаты-отправителя;  
2. **wxC** - состоит из трёх полей:  
    + w - результат взвешивания  
    + x - [x|y] литера, "имя" весов, принимает значения только **x** или **y**;  
    + С - [C|P|I] код события-инициатора запроса взвешивания; **C**  - (command) запрос командой интерфейса !WX, !WY; **P** - (proxy) считывание прокси-карты; **I** - (input) изменение состояния входного контакта.  
        + : - для команд **:** просто отделяет поле ответа без дополнительной информации
        + **I** "5c:" , "9o:" - номер контакта и его состояние, ставшие причиной запроса( аналогично *изменение состояния контакта*)
        + **P** "4:", "6:" - номер платы считывателя карт, вызвавшей запрос (первое поле в запросе вида **4pr0:3456789**)

3. **ST, SG 18680kg** - строка ответа от весов в неизменном виде; *при остутствии ответа принимает заначение "?"* ( пример: **0wxC:?**)  

**0tyP4:28** - информация о времени взвешивания
1. **0**  - номер платы-отправителя;
2. **tyP** - *"t + y + P"* - поля имеют тот же смысл, ***как и в ответе весов***, отличающиеся только том, что "w" заменяется на "t" (time), указывающее, что это время ответа. В приведённом случае весы "y" выполняли измерение веса по срабатыванию считывателя прокси карты;
3. **28**  - время **в миллисекундах** до получения ответа или истечения интервала ожидания (например, при неисправных весах);
 *ПРИМЕЧАНИЕ:* данное событие имеет единственную причину возникновения - запрос взвешивания и всегда следует за ответом весов (строка ответа которого может быть пустой).

## Технические детали

Устройство состоит из нескольких плат, соединённых последовательно и имеющая каждая свой номер, задаваемый внешними компонентами. Номер платы служит для определения источника сообщения. Номера задаются выводами 4, 3, 2, 1, 0 (A4, A3, A2, A1, A0) задающие соответствующие биты номера от старшего к младшему.

Входами устройства служат выводы с номерами 5..9, состояние которых может быть опрошено внутренней программой.

Остальные выводы используются как выходы и могут быть подключены для управления реле или другими механизмами. Последний адресуемый вывод имеет номер 19 для Arduino Pro и 69 для Mega2560. Mega2560 так же использует часть выводов для терминалов, взаимодействующих с весами и компьютером, которые в следствие этого недоступны для команд установки уровней.

Для управления выводами *74hc595* напрямую используестя команды !R и !r (см. описание).

Буфер вмещает до 64 сообщений, и сохраняет их до удаления командами или отключения питания. Задаётся макросом **MSG_Capacity**. Длинна сообщений ограничена 16 символами для Arduino Pro и 32 символами для Arduino Mega2560; задаётся макросом **idlen**.

Для Mega2560 выводы 51 и 52 сконфигурированы как входы и предполагается использовать для инициирования взвешивания по запросу оператора.





